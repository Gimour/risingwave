auto-retry: &auto-retry
  automatic:
    # Agent terminated because the AWS EC2 spot instance killed by AWS.
    - signal_reason: agent_stop
      limit: 3

steps:
  - label: "build"
    command: "ci/scripts/build.sh -p ci-release"
    if: |
      !(build.pull_request.labels includes "ci/main-cron/skip-ci") && build.env("CI_STEPS") == null
      || build.pull_request.labels includes "ci/run-build"
      || build.env("CI_STEPS") =~ /(^|,)build(,|$$)/
    key: "build"
    plugins:
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 20
    retry: *auto-retry

  - label: "build other components"
    command: "ci/scripts/build-other.sh"
    if: |
      !(build.pull_request.labels includes "ci/main-cron/skip-ci") && build.env("CI_STEPS") == null
      || build.pull_request.labels includes "ci/run-build-other"
      || build.env("CI_STEPS") =~ /(^|,)build-other(,|$$)/
    key: "build-other"
    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            GITHUB_TOKEN: github-token
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
          environment:
            - GITHUB_TOKEN
    timeout_in_minutes: 12
    retry: *auto-retry

  - label: "docslt"
    command: "ci/scripts/docslt.sh"
    if: |
      !(build.pull_request.labels includes "ci/main-cron/skip-ci") && build.env("CI_STEPS") == null
      || build.pull_request.labels includes "ci/run-docslt"
      || build.env("CI_STEPS") =~ /(^|,)docslt(,|$$)/
    key: "docslt"
    plugins:
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 10
    retry: *auto-retry

  - label: "end-to-end test (release)"
    key: "e2e-test-release"
    command: "ci/scripts/cron-e2e-test.sh -p ci-release -m ci-3streaming-2serving-3fe"
    if: |
      !(build.pull_request.labels includes "ci/main-cron/skip-ci") && build.env("CI_STEPS") == null
      || build.pull_request.labels includes "ci/run-e2e-test"
      || build.env("CI_STEPS") =~ /(^|,)e2e-tests?(,|$$)/
    depends_on:
      - "build"
      - "build-other"
      - "docslt"
    plugins:
      - docker-compose#v5.1.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
      - ./ci/plugins/upload-failure-logs
    timeout_in_minutes: 65
    retry: *auto-retry
